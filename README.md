# ChocoPy PA4

student1: huab@shanghaitech.edu.cn
student2: zhangych6@shanghaitech.edu.cn

Compile the LightIR code to RiscV Assembly. [Start from using docker](./doc/common/build.md) and see the [doc](./doc/PA4/README.md).

## writeup

The challenge of this assignment was to implement functions and register allocations that conform to the RISC-V Calling Convention.

For the implementation of binary operations and some other instructions, we refer to The RISC-V Instruction Set Manual and the code generated by RISC-V rv32gc clang.

#### Some difficulties encountered and solutions

1. At the beginning of the project, because we had not learned CA1, we did not know how to write assembly, we did not know what each function was expected to do, and we did not have a simple example to guide how to write the code. Solution: By looking at the RISC-V assembly generated by chocopy.org to understand the task in general.
2. stdlib is different from PA3.
3. stdlib does not conform to the RISC-V Calling Convention.
4. not understanding the role of memory align causes myprintf.c to not work properly. Solution: Use the p2align instruction.
5. the PA3 code only guarantees the output LLVM-IR, resulting in the need to use std::string for indexing, which is a large overhead.
6. RiscVBackEnd framework has problems with some instruction generation.

#### What we have done

In commit #fb2c2003 we implemented a simple stack machine that uses only t0, t1, t2 registers and all variables are allocated on the stack.

In commit #45fc1a9d we implemented the liveness analysis and the linear scan register allocation.
The difficulty is that the function call needs to save the caller save register on demand and the function needs to save the callee save register on demand.

#### Code quality

1. remove useless code.
2. use assert to reduce error checking time.
3. merge similar code, such as add, sub, mul, div, rem, all implemented similarly, into a switch case.
4. use `[[nodiscard]]` attribute to add compiler warnings to prevent mistakes.
5. write comments and debug output to help teammates understand the work.
6. Use lambda function to make the code easier to understand.

#### Memory Management

This assignment does not show the use of pointers, all RAII.

#### How to Debug

Use `/llvm/bin/riscv64-unknown-elf-gdb` and `qemu-riscv32 -g`, along with the output in the middle of the program to debug efficiently.
